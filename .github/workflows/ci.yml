name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  # å‰ç«¯å»ºç½®èˆ‡æ¸¬è©¦
  frontend:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout ç¨‹å¼ç¢¼
        uses: actions/checkout@v4

      - name: è¨­å®š Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: å®‰è£ä¾è³´
        run: npm ci

      - name: ESLint ç¨‹å¼ç¢¼æª¢æŸ¥
        run: npm run lint:js

      - name: Prettier æ ¼å¼æª¢æŸ¥
        run: npx prettier --check '**/*.{js,css,html,md}'

      - name: Jest å–®å…ƒæ¸¬è©¦
        run: npm run test:js

      - name: ä¸Šå‚³æ¸¬è©¦è¦†è“‹ç‡å ±å‘Š
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage/lcov.info
          flags: frontend

  # Python è³‡æ–™è™•ç†æ¸¬è©¦
  python:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout ç¨‹å¼ç¢¼
        uses: actions/checkout@v4

      - name: è¨­å®š Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: å®‰è£ Python ä¾è³´
        run: |
          pip install -r requirements.txt
          pip install pytest pytest-cov ruff black bandit

      - name: Ruff ç¨‹å¼ç¢¼æª¢æŸ¥
        run: ruff check *.py

      - name: Black æ ¼å¼æª¢æŸ¥
        run: black --check *.py

      - name: Bandit å®‰å…¨æƒæ
        run: bandit -r *.py

      - name: Pytest æ¸¬è©¦
        run: pytest --cov=. --cov-report=xml

      - name: ä¸Šå‚³ Python è¦†è“‹ç‡å ±å‘Š
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage.xml
          flags: python

  # æ•ˆèƒ½èˆ‡å®‰å…¨æª¢æŸ¥
  quality:
    runs-on: ubuntu-latest
    needs: [frontend, python]

    steps:
      - name: Checkout ç¨‹å¼ç¢¼
        uses: actions/checkout@v4

      - name: è¨­å®š Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: å®‰è£ Lighthouse CI
        run: npm install -g @lhci/cli@0.12.x

      - name: å•Ÿå‹•éœæ…‹ä¼ºæœå™¨
        run: |
          python3 -m http.server 8000 &
          sleep 5

      - name: Lighthouse æ•ˆèƒ½æ¸¬è©¦ (å¯¬é¬†æ¨™æº–)
        run: |
          # ä½¿ç”¨å¯¬é¬†çš„æ•ˆèƒ½æ¨™æº–
          lhci autorun --upload.target=temporary-public-storage --collect.url=http://localhost:8000 \
            --assert.assertions.performance=0.5 \
            --assert.assertions.accessibility=0.7 \
            --assert.assertions.best-practices=0.6 \
            --assert.assertions.seo=0.7
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}

  # GitHub Pages éƒ¨ç½² (åƒ…é™ main åˆ†æ”¯)
  deploy:
    runs-on: ubuntu-latest
    needs: [frontend, python, quality]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    # è¨­å®š GitHub Pages éƒ¨ç½²æ¬Šé™
    permissions:
      contents: read
      pages: write
      id-token: write

    # é˜²æ­¢ä¸¦è¡Œéƒ¨ç½²
    concurrency:
      group: 'pages'
      cancel-in-progress: false

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Checkout ç¨‹å¼ç¢¼
        uses: actions/checkout@v4

      - name: è¨­å®š Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: å»ºç½®éœæ…‹æª”æ¡ˆ
        run: |
          # ç¢ºä¿æ‰€æœ‰éœæ…‹æª”æ¡ˆéƒ½æº–å‚™å¥½
          echo "ğŸ”„ æº–å‚™ GitHub Pages éƒ¨ç½²æª”æ¡ˆ..."

          # å»ºç«‹ build ç›®éŒ„ä¸¦è¤‡è£½æ‰€æœ‰å¿…è¦æª”æ¡ˆ
          mkdir -p build
          cp -r *.html build/
          cp -r css/ build/ 2>/dev/null || true
          cp -r js/ build/ 2>/dev/null || true
          cp -r partials/ build/ 2>/dev/null || true
          cp -r txt/ build/ 2>/dev/null || true
          cp -r icon/ build/ 2>/dev/null || true
          cp -r docs/ build/ 2>/dev/null || true
          cp *.csv build/ 2>/dev/null || true
          cp *.json build/ 2>/dev/null || true

          # å»ºç«‹ _config.yml æª”æ¡ˆ (GitHub Pages è¨­å®š)
          echo "plugins:" > build/_config.yml
          echo "  - jekyll-relative-links" >> build/_config.yml
          echo "relative_links:" >> build/_config.yml
          echo "  enabled: true" >> build/_config.yml
          echo "  collections: true" >> build/_config.yml

          # å»ºç«‹ .nojekyll æª”æ¡ˆ (åœç”¨ Jekyll è™•ç†)
          touch build/.nojekyll

          echo "âœ… éœæ…‹æª”æ¡ˆå»ºç½®å®Œæˆ"
          ls -la build/

      - name: è¨­å®š GitHub Pages
        uses: actions/configure-pages@v4

      - name: ä¸Šå‚³ GitHub Pages æª”æ¡ˆ
        uses: actions/upload-pages-artifact@v3
        with:
          path: './build'

      - name: éƒ¨ç½²åˆ° GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
