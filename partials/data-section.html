<!-- 數據表格區域 - 修改版 -->
<div class="overflow-x-auto mb-12 fade-in">
  <!-- Placeholder for original filter elements that will be moved and enhanced -->
  <div id="initial-filter-elements" style="display: none">
    <select id="broker-filter"></select>
    <select id="date-filter"></select>
  </div>

  <!-- 表格控制項將由JS動態添加 -->

  <!-- 經典表格視圖 -->
  <div class="table-wrapper classic-view-table">
    <table id="csv-table" class="w-full bg-white rounded-lg shadow-card">
      <thead>
        <tr class="bg-secondary text-white text-left">
          <th class="p-4 rounded-tl-lg">券商</th>
          <th class="p-4">產品</th>
          <th class="p-4 dt-right font-bold">責任額</th>
          <th class="p-4 rounded-tr-lg">募集期間</th>
        </tr>
      </thead>
      <tbody>
        <!-- 表格數據將由JavaScript動態載入 -->
      </tbody>
    </table>
  </div>

  <!-- 產品視圖表格容器 - 將由JavaScript動態創建 -->
</div>

<!-- 數據視覺化區域 - 將由JavaScript動態創建 -->

<section
  id="insight-panel"
  class="bg-secondary text-white p-8 rounded-lg shadow-card fade-in relative"
>
  <h3 class="text-xl font-bold mb-6 flex items-center gap-2">
    <span>殘酷事實・即時揭露</span>
    <div class="relative">
      <button
        id="formula-info-btn"
        class="w-5 h-5 rounded-full bg-white/20 hover:bg-white/30 flex items-center justify-center transition-colors"
      >
        <i class="fas fa-info-circle text-xs"></i>
      </button>
      <!-- 公式說明浮動框 -->
      <div
        id="formula-info"
        class="hidden absolute right-0 top-8 w-72 bg-white/10 backdrop-blur-sm rounded-lg p-4 shadow-xl z-10 text-xs"
      >
        <h4 class="font-semibold mb-2 text-white/90">📊 計算公式說明</h4>
        <ul class="space-y-2 text-white/80">
          <li>• 最高責任額 = MAX(所有商品責任額)</li>
          <li>• 最低責任額 = MIN(所有非零責任額)</li>
          <li>• 最高/最低倍數 = 最高責任額 / 最低責任額</li>
          <li>• 平均募集天數 = SUM(募集天數) / 商品數</li>
          <li>• 每日責任額 = 責任額 / 募集天數</li>
          <li>• 每小時配額 = 每日責任額 / 8</li>
          <li>
            • 地獄月份計算： <br />1. 依年月分組統計商品數 <br />2.
            找出單月商品數最多的月份 <br />3. 顯示年份及該月商品數量
          </li>
        </ul>
      </div>
    </div>
  </h3>

  <div class="grid grid-cols-1 md:grid-cols-2 gap-6 leading-relaxed">
    <!-- 左欄 -->
    <ul class="space-y-4">
      <li class="flex items-start">
        <i class="fas fa-exclamation-triangle text-red-400 mt-1 mr-3"></i>
        <span>
          <strong>瘋狂天花板</strong>：單檔責任額最高
          <span id="ins-maxResp" class="counter text-yellow-300">0</span> 萬，
          是最低額度的 <span id="ins-ratioResp" class="counter">0</span> 倍！
        </span>
      </li>

      <li class="flex items-start">
        <i class="fas fa-stopwatch text-orange-300 mt-1 mr-3"></i>
        <span>
          <strong>壓縮週期</strong>：平均募集期僅
          <span id="ins-avgDays" class="counter">0</span> 天， 史上最短
          <span id="ins-minDays" class="counter">0</span> 天， 比傳統 30 天少
          <span id="ins-cutPct" class="counter">0</span>％！
        </span>
      </li>

      <li class="flex items-start">
        <i class="fas fa-calendar-alt text-green-300 mt-1 mr-3"></i>
        <span>
          <strong>地獄月份</strong>：
          <span id="ins-hellYear" class="counter">0</span> 年
          <span id="ins-hellMonth" class="counter">0</span> 月爆出
          <span id="ins-hellCount" class="counter">0</span> 檔商品同步開賣
          <!-- <span class="text-xs text-white/70 block mt-1">
            <i class="fas fa-info-circle mr-1"></i>依商品代碼去重後計算
          </span> -->
        </span>
      </li>
    </ul>

    <!-- 右欄 -->
    <ul class="space-y-4">
      <li class="flex items-start">
        <i class="fas fa-burn text-pink-400 mt-1 mr-3"></i>
        <span>
          <strong>日爆量</strong>：平均每日必須衝
          <span id="ins-avgPerDay" class="counter">0</span> 萬責任額！
        </span>
      </li>

      <li class="flex items-start">
        <i class="fas fa-hourglass-half text-blue-300 mt-1 mr-3"></i>
        <span>
          <strong>每小時 KPI</strong>：<span id="ins-hrQuota" class="counter"
            >0</span
          >
          萬／小時，喘口氣都奢侈！
        </span>
      </li>

      <li class="flex items-start">
        <i class="fas fa-skull-crossbones text-red-500 mt-1 mr-3"></i>
        <span>
          <strong>最恐怖一天</strong>：<span id="ins-peakDate">—</span>
          單日責任額飆破 <span id="ins-peakAmt" class="counter">0</span> 萬！
        </span>
      </li>
    </ul>
  </div>

  <!-- 添加公式說明的JavaScript -->
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const formulaBtn = document.getElementById("formula-info-btn");
      const formulaInfo = document.getElementById("formula-info");
      let isVisible = false;

      // 點擊按鈕切換顯示
      formulaBtn.addEventListener("click", function (e) {
        e.stopPropagation();
        isVisible = !isVisible;
        formulaInfo.classList.toggle("hidden", !isVisible);
      });

      // 點擊其他地方關閉
      document.addEventListener("click", function (e) {
        if (isVisible && !formulaInfo.contains(e.target)) {
          isVisible = false;
          formulaInfo.classList.add("hidden");
        }
      });

      // 滑鼠懸浮也可以顯示
      formulaBtn.addEventListener("mouseenter", function () {
        isVisible = true;
        formulaInfo.classList.remove("hidden");
      });

      formulaBtn.addEventListener("mouseleave", function (e) {
        // 檢查滑鼠是否移動到公式說明框上
        const rect = formulaInfo.getBoundingClientRect();
        if (
          e.clientX < rect.left ||
          e.clientX > rect.right ||
          e.clientY < rect.top ||
          e.clientY > rect.bottom
        ) {
          isVisible = false;
          formulaInfo.classList.add("hidden");
        }
      });

      formulaInfo.addEventListener("mouseleave", function () {
        isVisible = false;
        formulaInfo.classList.add("hidden");
      });
    });
  </script>
</section>
